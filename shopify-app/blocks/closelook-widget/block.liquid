{% comment %}
  Closelook Try-On Widget Block
  Adds virtual try-on widget to product pages with proper isolation
{% endcomment %}

<div id="closelook-try-on-container">
  <div
    id="closelook-try-on-widget"
    data-shop-domain="{{ shop.domain }}"
    data-product-id="{{ product.id }}"
    data-product-handle="{{ product.handle }}"
    data-widget-position="{{ block.settings.position }}"
    data-api-url="{{ block.settings.api_url | default: 'https://your-app.onrender.com/api' }}"
  >
    {% comment %} Widget will be injected here {% endcomment %}
  </div>
</div>

<style>
  /* Isolated styles for Closelook Try-On Widget */
  #closelook-try-on-container {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 999999;
    pointer-events: none;
  }
  
  #closelook-try-on-container * {
    pointer-events: auto;
  }
  
  #closelook-try-on-widget {
    position: relative;
  }
</style>

<script>
  (function() {
    'use strict';
    
    const widgetContainer = document.getElementById('closelook-try-on-widget');
    if (!widgetContainer) {
      console.error('Closelook: Widget container not found');
      return;
    }

    // Extract product data from Shopify global object or DOM
    let shopifyProduct;
    
    try {
      // Try to get from window.Shopify if available
      if (window.Shopify && window.Shopify.product) {
        shopifyProduct = window.Shopify.product;
      } else {
        // Fallback: construct from Liquid variables and DOM
        shopifyProduct = {
          id: widgetContainer.dataset.productId,
          handle: widgetContainer.dataset.productHandle,
          title: '{{ product.title | escape }}',
          description: '{{ product.description | strip_html | truncate: 200 | escape }}',
          images: [],
          variants: [],
          product_type: '{{ product.type | escape }}',
          tags: {{ product.tags | json }},
          vendor: '{{ product.vendor | escape }}'
        };
        
        // Try to extract images from DOM
        const imageSelectors = [
          '.product__media img',
          '.product-images img',
          '.product-photos img',
          '.product-gallery img',
          '[data-product-media] img'
        ];
        
        imageSelectors.forEach(selector => {
          const images = document.querySelectorAll(selector);
          if (images.length > 0) {
            shopifyProduct.images = Array.from(images).slice(0, 5).map(img => {
              return img.src || img.dataset.src || img.currentSrc || 
                     (img.getAttribute('srcset') ? img.getAttribute('srcset').split(',')[0].trim().split(' ')[0] : '');
            }).filter(Boolean);
            return;
          }
        });
        
        // Try to extract price from DOM
        const priceElements = document.querySelectorAll('.price, .product-price, [data-price]');
        if (priceElements.length > 0) {
          const priceText = priceElements[0].textContent;
          const priceMatch = priceText.match(/[\d,]+\.?\d*/);
          if (priceMatch) {
            shopifyProduct.variants = [{
              price: parseFloat(priceMatch[0].replace(/,/g, '')),
              title: 'Default'
            }];
          }
        }
      }
    } catch (error) {
      console.error('Closelook: Error extracting product data', error);
      shopifyProduct = null;
    }

    // Load widget bundle
    const apiUrl = widgetContainer.dataset.apiUrl || 'https://your-app.onrender.com/api';
    const widgetUrl = apiUrl.replace('/api', '') + '/widgets/try-on-widget.js';
    
    // Check if widget is already loaded
    if (window.CloselookTryOnWidget) {
      window.CloselookTryOnWidget.init({
        container: widgetContainer,
        product: shopifyProduct,
        shopDomain: widgetContainer.dataset.shopDomain,
        apiUrl: apiUrl
      });
      return;
    }
    
    const script = document.createElement('script');
    script.src = widgetUrl;
    script.async = true;
    
    script.onload = function() {
      if (window.CloselookTryOnWidget) {
        window.CloselookTryOnWidget.init({
          container: widgetContainer,
          product: shopifyProduct,
          shopDomain: widgetContainer.dataset.shopDomain,
          apiUrl: apiUrl
        });
      } else {
        console.error('Closelook: Widget loaded but init function not found');
      }
    };
    
    script.onerror = function() {
      console.error('Closelook: Failed to load try-on widget from', widgetUrl);
    };
    
    document.head.appendChild(script);
  })();
</script>

