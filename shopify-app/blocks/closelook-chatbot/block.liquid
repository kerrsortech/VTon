{% comment %}
  Closelook Chatbot Block
  Adds AI chatbot to product pages
{% endcomment %}

<div
  id="closelook-chatbot-widget"
  data-shop-domain="{{ shop.domain }}"
  data-product-id="{{ product.id }}"
  data-product-handle="{{ product.handle }}"
  data-widget-position="{{ block.settings.position }}"
  data-api-url="{{ block.settings.api_url | default: 'https://your-app.onrender.com/api' }}"
  style="position: {{ block.settings.position == 'bottom-right' ? 'fixed' : 'relative' }}; bottom: 100px; right: 24px; z-index: 9998;"
>
  {% comment %} Chatbot will be injected here {% endcomment %}
</div>

<script>
  (function() {
    const widgetContainer = document.getElementById('closelook-chatbot-widget');
    if (!widgetContainer) return;

    // Extract product data from Shopify global object or DOM
    const shopifyProduct = window.Shopify?.product || {
      id: widgetContainer.dataset.productId,
      handle: widgetContainer.dataset.productHandle,
      title: document.querySelector('h1.product-title')?.textContent || '{{ product.title }}',
      description: '{{ product.description | strip_html | truncate: 200 }}',
      images: Array.from(document.querySelectorAll('.product-images img, .product-photos img')).map(img => img.src || img.dataset.src || img.getAttribute('srcset')?.split(',')[0]?.trim().split(' ')[0]),
      variants: [{
        price: {{ product.selected_or_first_available_variant.price | money_without_currency | remove: ',' }},
        title: '{{ product.selected_or_first_available_variant.title }}'
      }],
      product_type: '{{ product.type }}',
      tags: {{ product.tags | json }},
      vendor: '{{ product.vendor }}'
    };

    // Load widget bundle from CDN or Render
    const apiUrl = widgetContainer.dataset.apiUrl || 'https://your-app.onrender.com/api';
    const widgetUrl = apiUrl.replace('/api', '') + '/widgets/chatbot-widget.js';
    
    const script = document.createElement('script');
    script.src = widgetUrl;
    script.onload = function() {
      if (window.CloselookChatbotWidget) {
        window.CloselookChatbotWidget.init({
          container: widgetContainer,
          product: shopifyProduct,
          shopDomain: widgetContainer.dataset.shopDomain,
          apiUrl: apiUrl
        });
      }
    };
    script.onerror = function() {
      console.error('Failed to load Closelook Chatbot Widget');
    };
    document.head.appendChild(script);
  })();
</script>

